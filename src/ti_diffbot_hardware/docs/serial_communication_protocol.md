# 串口通信协议说明

## 概览
ti_diffbot_hardware包的串口通信使用简单的ASCII文本格式，通过逗号分隔数据字段。

## 串口配置
- **设备路径**: `/dev/ttyCH341USB0`
- **波特率**: 115200
- **数据位**: 8
- **停止位**: 1
- **校验位**: 无
- **流控制**: 无

## 通信协议

### 1. 发送格式 (PC → 硬件)
```
<左轮RPM>,<右轮RPM>\n
```

**字段说明:**
- `<左轮RPM>`: 左轮目标转速 (单位: **输出轴RPM**, 保留2位小数)
- `<右轮RPM>`: 右轮目标转速 (单位: **输出轴RPM**, 保留2位小数)
- 字段间用逗号 `,` 分隔
- 行尾用换行符 `\n` 结束

**⚠️ 重要说明 - 转速单位:**
- **RPM指的是输出轴(轮子)的转速，不是电机转子转速**
- 单位: **转/分钟 (Revolutions Per Minute)**
- 这是经过减速器后的最终输出轴转速

**示例:**
```
10.50,-8.25
0.00,0.00
15.75,15.75
```

### 2. 接收格式 (硬件 → PC)
```
<左轮编码器>,<右轮编码器>,<左轮RPM>,<右轮RPM>\n
```

**字段说明:**
- `<左轮编码器>`: 左轮编码器累计刻度 (整数)
- `<右轮编码器>`: 右轮编码器累计刻度 (整数)  
- `<左轮RPM>`: 左轮当前实际转速 (浮点数, **输出轴RPM**)
- `<右轮RPM>`: 右轮当前实际转速 (浮点数, **输出轴RPM**)
- 字段间用逗号 `,` 分隔
- 行尾用换行符 `\n` 结束

**⚠️ 重要说明 - 转速单位:**
- **RPM指的是输出轴(轮子)的转速，不是电机转子转速**
- 单位: **转/分钟 (Revolutions Per Minute)**
- 这是经过减速器后的最终输出轴转速
- 与ros2_control中的关节速度直接对应

**示例:**
```
1024,2048,12.5,-10.2
0,0,0.0,0.0
-512,1536,8.7,15.3
```

## 数据转换

### 转速单位详细说明

**🎯 关键概念:**
- **输出轴RPM**: 轮子最终转速，这是串口通信中使用的单位
- **电机转子RPM**: 电机本身的转速，通过减速器后变为输出轴转速
- **关系**: `电机RPM = 输出轴RPM × 减速比(36:1)`

**📊 转速换算示例:**
```
配置参数: gear_ratio = 36.0 (减速比36:1)

输出轴转速 10 RPM → 电机转速 = 10 × 36 = 360 RPM
输出轴转速 20 RPM → 电机转速 = 20 × 36 = 720 RPM
```

**🔧 ros2_control关节速度转换:**
```cpp
// ros2_control使用rad/s作为关节速度单位
// 这里的关节指的是轮子(输出轴)，不是电机

// 输出轴RPM → 关节速度(rad/s)
joint_velocity_rad_s = output_shaft_rpm * 2.0 * M_PI / 60.0;

// 关节速度(rad/s) → 输出轴RPM  
output_shaft_rpm = joint_velocity_rad_s * 60.0 / (2.0 * M_PI);
```

### RPM 到 rad/s 转换
```cpp
// RPM转换为rad/s
vel_rad_s = rpm * 2.0 * M_PI / 60.0;

// rad/s转换为RPM
rpm = vel_rad_s * 60.0 / (2.0 * M_PI);
```

### 编码器刻度到位置转换
```cpp
// 配置参数
enc_ticks_per_rev = 8192.0;  // 编码器每转刻度数
gear_ratio = 36.0;           // 减速比 (电机:输出轴 = 36:1)
rad_per_tick = 2.0 * M_PI / (enc_ticks_per_rev * gear_ratio);

// 编码器刻度转换为输出轴角度(弧度)
wheel_position_rad = encoder_ticks * rad_per_tick;

// 说明: 编码器安装在电机轴上，每电机转36圈，输出轴转1圈
// 因此需要用减速比进行转换以得到实际轮子位置
```

### 速度和位置的物理意义
```cpp
// 在ros2_control框架中:
// - joint position: 轮子(输出轴)的角度 [弧度]
// - joint velocity: 轮子(输出轴)的角速度 [弧度/秒]
// 
// 在串口通信中:
// - RPM: 轮子(输出轴)的转速 [转/分钟]
// - encoder_ticks: 电机轴的累计刻度 [个]
```

## 通信流程

### 初始化阶段
1. 打开串口设备 `/dev/ttyCH341USB0`
2. 配置串口参数 (115200, 8N1)
3. 清空输入/输出缓冲区

### 运行阶段
**读取循环 (read函数):**
1. 调用 `read_line()` 读取一行数据
2. 用逗号分割字符串得到4个字段
3. 解析编码器值和RPM值
4. 更新关节位置和速度状态

**写入循环 (write函数):**
1. 将命令速度从 rad/s 转换为 RPM
2. 格式化为 "RPM_L,RPM_R" 字符串
3. 调用 `write_line()` 发送到串口

### 停用阶段
1. 发送停止命令 `"0.0,0.0"`
2. 关闭串口设备

## 错误处理

### 数据解析错误
- 如果接收到的数据字段数量不足4个，忽略该行
- 如果数值解析失败，记录警告日志并忽略该行
- 使用 `RCLCPP_WARN_THROTTLE` 限制错误日志频率

### 串口错误
- 串口打开失败时返回ERROR状态
- 读写操作失败时继续运行，不中断系统

## 仿真模式
当 `simulation_mode=true` 时:
- 跳过所有串口操作
- 使用数学模型模拟轮子运动
- `write()` 函数直接返回，不发送数据
- `read()` 函数使用积分器模拟位置和速度

## 硬件要求
- 下位机必须以115200波特率发送4字段CSV格式数据
- 数据更新频率应与控制循环频率匹配
- 建议发送频率: 50-100Hz
